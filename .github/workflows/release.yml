name: Release Build

on:
  push:
    tags:
      - 'v*'
  pull_request:
    branches: [ main ]
    types: [ closed ]
  schedule:
    # æ¯é€±æœˆæ›œæ—¥ã®åˆå‰9æ™‚ï¼ˆJSTï¼‰ã«ãƒªãƒªãƒ¼ã‚¹å€™è£œã‚’ãƒã‚§ãƒƒã‚¯
    - cron: '0 0 * * 1'  # UTC 00:00 = JST 09:00
  workflow_dispatch:
    inputs:
      version:
        description: 'Release version (e.g., v1.0.0)'
        required: true
        default: 'v1.0.0'
      release_type:
        description: 'Release type'
        required: true
        default: 'patch'
        type: choice
        options:
          - patch
          - minor
          - major
          - beta
          - rc
      force_release:
        description: 'Force release even if no changes detected'
        required: false
        default: false
        type: boolean

permissions:
  contents: write
  actions: read

env:
  FLUTTER_VERSION: '3.35.3'

jobs:
  # ãƒªãƒªãƒ¼ã‚¹å‰ã®æœ€çµ‚ãƒã‚§ãƒƒã‚¯
  pre-release-checks:
    runs-on: ubuntu-latest
    name: Pre-Release Quality Checks
    outputs:
      should_release: ${{ steps.release_check.outputs.should_release }}
      release_reason: ${{ steps.release_check.outputs.release_reason }}
    if: >
      github.event_name == 'push' && startsWith(github.ref, 'refs/tags/') ||
      github.event_name == 'workflow_dispatch' ||
      (github.event_name == 'pull_request' && github.event.pull_request.merged == true && github.event.pull_request.base.ref == 'main') ||
      github.event_name == 'schedule'

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup Flutter
      uses: subosito/flutter-action@v2
      with:
        flutter-version: ${{ env.FLUTTER_VERSION }}
        channel: 'stable'
        cache: true

    - name: Get dependencies
      env:
        APP_ENV: dev
        DATABASE_NAME: tech_lingual_quest_test.db
        API_BASE_URL: https://api.example.com
        LOG_LEVEL: error
      run: flutter pub get

    - name: Run all tests
      env:
        APP_ENV: dev
        DATABASE_NAME: tech_lingual_quest_test.db
        API_BASE_URL: https://api.example.com
        LOG_LEVEL: error
        ENABLE_ANALYTICS: false
        ENABLE_CRASHLYTICS: false
      run: flutter test --coverage

    - name: Analyze code
      env:
        APP_ENV: dev
        DATABASE_NAME: tech_lingual_quest_test.db
        API_BASE_URL: https://api.example.com
        LOG_LEVEL: error
      run: flutter analyze

    - name: Check formatting
      run: dart format --output=none --set-exit-if-changed .

    - name: Determine release necessity
      id: release_check
      run: |
        SHOULD_RELEASE=false
        RELEASE_REASON=""
        
        if [ "${{ github.event_name }}" == "push" ] && [[ "${{ github.ref }}" == refs/tags/* ]]; then
          SHOULD_RELEASE=true
          RELEASE_REASON="ã‚¿ã‚°ä»˜ããƒªãƒªãƒ¼ã‚¹ (æ‰‹å‹•ã¾ãŸã¯GitHub)"
        elif [ "${{ github.event_name }}" == "workflow_dispatch" ]; then
          SHOULD_RELEASE=true
          RELEASE_REASON="æ‰‹å‹•å®Ÿè¡Œãƒªãƒªãƒ¼ã‚¹"
        elif [ "${{ github.event_name }}" == "pull_request" ] && [ "${{ github.event.pull_request.merged }}" == "true" ]; then
          # mainãƒ–ãƒ©ãƒ³ãƒã«ãƒãƒ¼ã‚¸ã•ã‚ŒãŸå ´åˆã€ãƒªãƒªãƒ¼ã‚¹å¯¾è±¡ã®changelogã‚’ãƒã‚§ãƒƒã‚¯
          if git log --oneline HEAD~5..HEAD | grep -E "(feat|fix|BREAKING)" >/dev/null; then
            SHOULD_RELEASE=true
            RELEASE_REASON="mainãƒ–ãƒ©ãƒ³ãƒãƒãƒ¼ã‚¸å¾Œã®è‡ªå‹•ãƒªãƒªãƒ¼ã‚¹"
          else
            echo "âš ï¸ é‡è¦ãªå¤‰æ›´ãŒæ¤œå‡ºã•ã‚Œã¾ã›ã‚“ã§ã—ãŸã€‚ãƒªãƒªãƒ¼ã‚¹ã‚’ã‚¹ã‚­ãƒƒãƒ—ã—ã¾ã™ã€‚"
          fi
        elif [ "${{ github.event_name }}" == "schedule" ]; then
          # ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«å®Ÿè¡Œã®å ´åˆã€å‰å›ãƒªãƒªãƒ¼ã‚¹ã‹ã‚‰ä¸€é€±é–“ä»¥ä¸ŠçµŒéã—ã€ã‹ã¤å¤‰æ›´ãŒã‚ã‚‹å ´åˆ
          LAST_RELEASE=$(git describe --tags --abbrev=0 HEAD 2>/dev/null || echo "")
          if [ -n "$LAST_RELEASE" ]; then
            DAYS_SINCE_RELEASE=$(( ( $(date +%s) - $(git log -1 --format="%ct" $LAST_RELEASE) ) / 86400 ))
            if [ $DAYS_SINCE_RELEASE -ge 7 ] && git log --oneline $LAST_RELEASE..HEAD | grep -E "(feat|fix)" >/dev/null; then
              SHOULD_RELEASE=true
              RELEASE_REASON="é€±æ¬¡è‡ªå‹•ãƒªãƒªãƒ¼ã‚¹ (å‰å›ã‹ã‚‰${DAYS_SINCE_RELEASE}æ—¥çµŒé)"
            fi
          fi
        fi
        
        echo "should_release=$SHOULD_RELEASE" >> $GITHUB_OUTPUT
        echo "release_reason=$RELEASE_REASON" >> $GITHUB_OUTPUT
        
        if [ "$SHOULD_RELEASE" == "true" ]; then
          echo "âœ… ãƒªãƒªãƒ¼ã‚¹å®Ÿè¡Œ: $RELEASE_REASON"
        else
          echo "â­ï¸ ãƒªãƒªãƒ¼ã‚¹ã‚’ã‚¹ã‚­ãƒƒãƒ—: å®Ÿè¡Œæ¡ä»¶ã‚’æº€ãŸã—ã¦ã„ã¾ã›ã‚“"
        fi

    - name: Validate project structure
      if: steps.release_check.outputs.should_release == 'true' || github.event.inputs.force_release == 'true'
      run: ./validate_flutter_setup.sh

  # Android Release Build
  build-android:
    runs-on: ubuntu-latest
    name: Build Android Release
    needs: pre-release-checks
    if: needs.pre-release-checks.outputs.should_release == 'true' || github.event.inputs.force_release == 'true'

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup Flutter
      uses: subosito/flutter-action@v2
      with:
        flutter-version: ${{ env.FLUTTER_VERSION }}
        channel: 'stable'
        cache: true

    - name: Setup Java
      uses: actions/setup-java@v4
      with:
        distribution: 'zulu'
        java-version: '11'

    - name: Get dependencies
      env:
        APP_ENV: prod
        DATABASE_NAME: tech_lingual_quest.db
        API_BASE_URL: https://api.example.com
        LOG_LEVEL: error
      run: flutter pub get

    - name: Build Android APK (Release)
      run: |
        export APP_ENV=prod
        export DATABASE_NAME=tech_lingual_quest.db
        export API_BASE_URL=https://api.example.com
        export GRADLE_OPTS="-Xmx4G -XX:MaxMetaspaceSize=1G -XX:ReservedCodeCacheSize=512m -XX:+HeapDumpOnOutOfMemoryError"
        flutter build apk --release
        echo "APK_PATH=$(find build/app/outputs/flutter-apk -name '*.apk' | head -1)" >> $GITHUB_ENV
        echo "APK_SIZE=$(du -h build/app/outputs/flutter-apk/*.apk | cut -f1)" >> $GITHUB_ENV

    - name: Build Android App Bundle (Release)
      run: |
        export APP_ENV=prod
        export DATABASE_NAME=tech_lingual_quest.db
        export API_BASE_URL=https://api.example.com
        export GRADLE_OPTS="-Xmx4G -XX:MaxMetaspaceSize=1G -XX:ReservedCodeCacheSize=512m -XX:+HeapDumpOnOutOfMemoryError"
        flutter build appbundle --release
        echo "AAB_PATH=$(find build/app/outputs/bundle -name '*.aab' | head -1)" >> $GITHUB_ENV
        echo "AAB_SIZE=$(du -h build/app/outputs/bundle/*/*.aab | cut -f1)" >> $GITHUB_ENV

    - name: Upload Android Release APK
      uses: actions/upload-artifact@v4
      with:
        name: android-release-apk
        path: build/app/outputs/flutter-apk/*.apk
        retention-days: 30

    - name: Upload Android Release Bundle
      uses: actions/upload-artifact@v4
      with:
        name: android-release-bundle
        path: build/app/outputs/bundle/*/*.aab
        retention-days: 30

  # Web Release Build
  build-web:
    runs-on: ubuntu-latest
    name: Build Web Release
    needs: pre-release-checks
    if: needs.pre-release-checks.outputs.should_release == 'true' || github.event.inputs.force_release == 'true'

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup Flutter
      uses: subosito/flutter-action@v2
      with:
        flutter-version: ${{ env.FLUTTER_VERSION }}
        channel: 'stable'
        cache: true

    - name: Get dependencies
      env:
        APP_ENV: prod
        DATABASE_NAME: tech_lingual_quest.db
        API_BASE_URL: https://api.example.com
        LOG_LEVEL: error
      run: flutter pub get

    - name: Build Web (Release)
      run: |
        export APP_ENV=prod
        export DATABASE_NAME=tech_lingual_quest.db
        export API_BASE_URL=https://api.example.com
        flutter build web --release --verbose
        echo "WEB_SIZE=$(du -sh build/web | cut -f1)" >> $GITHUB_ENV

    - name: Upload Web Release
      uses: actions/upload-artifact@v4
      with:
        name: web-release
        path: build/web/
        retention-days: 30

  # ãƒªãƒªãƒ¼ã‚¹ãƒãƒ¼ãƒˆä½œæˆã¨GitHub Release
  create-release:
    runs-on: ubuntu-latest
    name: Create GitHub Release
    needs: [pre-release-checks, build-android, build-web]
    if: (startsWith(github.ref, 'refs/tags/') || github.event_name == 'workflow_dispatch' || (github.event_name == 'pull_request' && github.event.pull_request.merged == true)) && (needs.pre-release-checks.outputs.should_release == 'true' || github.event.inputs.force_release == 'true')

    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: Get version from tag or input
      id: version
      run: |
        if [ "${{ github.event_name }}" == "workflow_dispatch" ]; then
          VERSION="${{ github.event.inputs.version }}"
          RELEASE_TYPE="${{ github.event.inputs.release_type }}"
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "version_number=${VERSION#v}" >> $GITHUB_OUTPUT
          echo "release_type=$RELEASE_TYPE" >> $GITHUB_OUTPUT
        elif [[ "${{ github.ref }}" == refs/tags/* ]]; then
          VERSION=${GITHUB_REF#refs/tags/}
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "version_number=${VERSION#v}" >> $GITHUB_OUTPUT
          echo "release_type=release" >> $GITHUB_OUTPUT
        else
          # è‡ªå‹•ãƒªãƒªãƒ¼ã‚¹ã®å ´åˆã€é©åˆ‡ãªãƒãƒ¼ã‚¸ãƒ§ãƒ³ã‚’ç”Ÿæˆ
          LAST_TAG=$(git describe --tags --abbrev=0 HEAD 2>/dev/null || echo "v0.0.0")
          NEXT_VERSION=$(echo $LAST_TAG | awk -F. '{$NF = $NF + 1;} 1' | sed 's/ /./g')
          echo "version=$NEXT_VERSION" >> $GITHUB_OUTPUT
          echo "version_number=${NEXT_VERSION#v}" >> $GITHUB_OUTPUT
          echo "release_type=auto" >> $GITHUB_OUTPUT
        fi

    - name: Generate release notes
      id: release_notes
      run: |
        # å‰å›ã®ã‚¿ã‚°ã‚’å–å¾—
        PREVIOUS_TAG=$(git describe --tags --abbrev=0 HEAD^ 2>/dev/null || echo "")

        if [ -n "$PREVIOUS_TAG" ]; then
          echo "changelog<<EOF" >> $GITHUB_OUTPUT
          echo "## ğŸš€ æ–°æ©Ÿèƒ½ã¨æ”¹å–„" >> $GITHUB_OUTPUT
          echo "" >> $GITHUB_OUTPUT
          git log --pretty=format:"- %s" $PREVIOUS_TAG..HEAD --grep="feat" >> $GITHUB_OUTPUT
          echo "" >> $GITHUB_OUTPUT
          echo "## ğŸ› ãƒã‚°ä¿®æ­£" >> $GITHUB_OUTPUT
          echo "" >> $GITHUB_OUTPUT
          git log --pretty=format:"- %s" $PREVIOUS_TAG..HEAD --grep="fix" >> $GITHUB_OUTPUT
          echo "" >> $GITHUB_OUTPUT
          echo "## ğŸ“š ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ" >> $GITHUB_OUTPUT
          echo "" >> $GITHUB_OUTPUT
          git log --pretty=format:"- %s" $PREVIOUS_TAG..HEAD --grep="docs" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT
        else
          echo "changelog=åˆå›ãƒªãƒªãƒ¼ã‚¹" >> $GITHUB_OUTPUT
        fi

    - name: Download Android APK
      uses: actions/download-artifact@v4
      with:
        name: android-release-apk
        path: ./release-assets/

    - name: Download Android Bundle
      uses: actions/download-artifact@v4
      with:
        name: android-release-bundle
        path: ./release-assets/

    - name: Download Web Release
      uses: actions/download-artifact@v4
      with:
        name: web-release
        path: ./web-release/

    - name: Create Web Release Archive
      run: |
        cd web-release
        zip -r ../release-assets/tech-lingual-quest-web-${{ steps.version.outputs.version }}.zip .

    - name: Rename APK for release
      run: |
        cd release-assets
        find . -name "*.apk" -exec mv {} tech-lingual-quest-${{ steps.version.outputs.version }}.apk \;

    - name: Create GitHub Release
      uses: softprops/action-gh-release@v2
      id: create_release
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      with:
        tag_name: ${{ steps.version.outputs.version }}
        name: TechLingual Quest ${{ steps.version.outputs.version }}
        body: |
          # TechLingual Quest ${{ steps.version.outputs.version }}

          ${{ steps.release_notes.outputs.changelog }}

          ## ğŸ“± ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰

          - **Android APK**: ã‚¹ãƒãƒ¼ãƒˆãƒ•ã‚©ãƒ³ãƒ»ã‚¿ãƒ–ãƒ¬ãƒƒãƒˆç”¨ï¼ˆGoogle Play å¤–ã§ã®é…å¸ƒï¼‰
          - **Android Bundle**: Google Play Store å‘ã‘é…å¸ƒç”¨
          - **Webç‰ˆ**: ãƒ–ãƒ©ã‚¦ã‚¶ã§å‹•ä½œã™ã‚‹ãƒãƒ¼ã‚¸ãƒ§ãƒ³

          ## ğŸ› ï¸ æŠ€è¡“ä»•æ§˜

          - Flutter SDK: ${{ env.FLUTTER_VERSION }}
          - å¯¾å¿œãƒ—ãƒ©ãƒƒãƒˆãƒ•ã‚©ãƒ¼ãƒ : Android 5.0+, iOS 11.0+, Web (Chrome, Firefox, Safari)
          - ãƒ“ãƒ«ãƒ‰æ—¥æ™‚: $(date '+%Y-%m-%d %H:%M:%S UTC')
        draft: false
        prerelease: false
        files: |
          ./release-assets/tech-lingual-quest-${{ steps.version.outputs.version }}.apk
          ./release-assets/tech-lingual-quest-web-${{ steps.version.outputs.version }}.zip

  # ãƒªãƒªãƒ¼ã‚¹é€šçŸ¥
  notify-release:
    runs-on: ubuntu-latest
    name: Send Release Notifications
    needs: [create-release]
    if: always()

    steps:
    - name: Get version from tag
      id: version
      run: |
        VERSION=${GITHUB_REF#refs/tags/}
        echo "version=$VERSION" >> $GITHUB_OUTPUT

    - name: Send Discord release notification
      if: vars.DISCORD_WEBHOOK_URL
      run: |
        curl -H "Content-Type: application/json" \
        -d '{
          "embeds": [{
            "title": "ğŸ‰ TechLingual Quest æ–°ãƒãƒ¼ã‚¸ãƒ§ãƒ³ãƒªãƒªãƒ¼ã‚¹!",
            "description": "ãƒãƒ¼ã‚¸ãƒ§ãƒ³ ${{ steps.version.outputs.version }} ãŒãƒªãƒªãƒ¼ã‚¹ã•ã‚Œã¾ã—ãŸï¼",
            "color": 3447003,
            "fields": [
              {"name": "ãƒãƒ¼ã‚¸ãƒ§ãƒ³", "value": "${{ steps.version.outputs.version }}", "inline": true},
              {"name": "ãƒ—ãƒ©ãƒƒãƒˆãƒ•ã‚©ãƒ¼ãƒ ", "value": "Androidãƒ»Web", "inline": true},
              {"name": "Flutter SDK", "value": "${{ env.FLUTTER_VERSION }}", "inline": true}
            ],
            "footer": {"text": "GitHub Releases"},
            "timestamp": "'$(date -u +%Y-%m-%dT%H:%M:%S.000Z)'",
            "url": "https://github.com/${{ github.repository }}/releases/tag/${{ steps.version.outputs.version }}"
          }]
        }' \
        ${{ vars.DISCORD_WEBHOOK_URL }}

    - name: Send Slack release notification
      if: vars.SLACK_WEBHOOK_URL
      run: |
        curl -X POST -H 'Content-type: application/json' \
        --data '{
          "text": "ğŸ‰ TechLingual Quest æ–°ãƒãƒ¼ã‚¸ãƒ§ãƒ³ãƒªãƒªãƒ¼ã‚¹!",
          "blocks": [
            {
              "type": "header",
              "text": {
                "type": "plain_text",
                "text": "ğŸ‰ TechLingual Quest ${{ steps.version.outputs.version }}"
              }
            },
            {
              "type": "section",
              "text": {
                "type": "mrkdwn",
                "text": "æ–°ã—ã„ãƒãƒ¼ã‚¸ãƒ§ãƒ³ãŒãƒªãƒªãƒ¼ã‚¹ã•ã‚Œã¾ã—ãŸï¼Android APK ã¨ Webç‰ˆ ãŒåˆ©ç”¨å¯èƒ½ã§ã™ã€‚"
              }
            },
            {
              "type": "actions",
              "elements": [
                {
                  "type": "button",
                  "text": {
                    "type": "plain_text",
                    "text": "ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ãƒšãƒ¼ã‚¸ã‚’é–‹ã"
                  },
                  "url": "https://github.com/${{ github.repository }}/releases/tag/${{ steps.version.outputs.version }}"
                }
              ]
            }
          ]
        }' \
        ${{ vars.SLACK_WEBHOOK_URL }}
