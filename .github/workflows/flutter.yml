name: Flutter CI/CD

on:
  pull_request:
    branches: [ main, develop ]
  workflow_dispatch:

permissions:
  contents: read
  actions: read
  security-events: write

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

env:
  FLUTTER_VERSION: '3.35.3'

jobs:
  # ä¾å­˜é–¢ä¿‚ã¨ã‚³ãƒ¼ãƒ‰å“è³ªãƒã‚§ãƒƒã‚¯
  quality-check:
    runs-on: ubuntu-latest
    name: Code Quality & Dependency Check

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup Flutter
      uses: subosito/flutter-action@v2
      with:
        flutter-version: ${{ env.FLUTTER_VERSION }}
        channel: 'stable'
        cache: true

    - name: Get dependencies
      env:
        APP_ENV: dev
        DATABASE_NAME: tech_lingual_quest_test.db
        API_BASE_URL: https://api.example.com
        LOG_LEVEL: error
      run: flutter pub get

    - name: Analyze project source
      env:
        APP_ENV: dev
        DATABASE_NAME: tech_lingual_quest_test.db
        API_BASE_URL: https://api.example.com
        LOG_LEVEL: error
      run: flutter analyze --no-fatal-infos || echo "é™çš„è§£æã§è­¦å‘ŠãŒæ¤œå‡ºã•ã‚Œã¾ã—ãŸ"

    - name: Validate project structure
      run: ./validate_flutter_setup.sh

  # ãƒ†ã‚¹ãƒˆå®Ÿè¡Œ
  test:
    runs-on: ubuntu-latest
    name: Unit & Widget Tests
    needs: quality-check

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup Flutter
      uses: subosito/flutter-action@v2
      with:
        flutter-version: ${{ env.FLUTTER_VERSION }}
        channel: 'stable'
        cache: true

    - name: Get dependencies
      env:
        APP_ENV: dev
        DATABASE_NAME: tech_lingual_quest_test.db
        API_BASE_URL: https://api.example.com
        LOG_LEVEL: error
      run: flutter pub get

    - name: Run tests with coverage
      env:
        APP_ENV: dev
        DATABASE_NAME: tech_lingual_quest_test.db
        API_BASE_URL: https://api.example.com
        LOG_LEVEL: error
        ENABLE_ANALYTICS: false
        ENABLE_CRASHLYTICS: false
      run: |
        flutter test --coverage
        # codecovãƒ¬ãƒãƒ¼ãƒˆç”¨ã®ãƒ†ã‚¹ãƒˆã‚«ãƒãƒ¬ãƒƒã‚¸ãƒ•ã‚¡ã‚¤ãƒ«ãŒä½œæˆã•ã‚Œã¦ã„ã‚‹ã“ã¨ã‚’ç¢ºèª
        if [ -f coverage/lcov.info ]; then
          echo "Coverage file generated successfully"
          head -10 coverage/lcov.info
        else
          echo "Warning: Coverage file not generated"
        fi

    - name: Upload coverage to Codecov
      uses: codecov/codecov-action@v4
      with:
        file: coverage/lcov.info
        fail_ci_if_error: false
        token: ${{ secrets.CODECOV_TOKEN }}
        verbose: true

  build:
    runs-on: ubuntu-latest
    name: Build Applications
    needs: quality-check  # testã¨ä¸¦åˆ—å®Ÿè¡Œ
    strategy:
      fail-fast: false  # ä¸€ã¤ãŒå¤±æ•—ã—ã¦ã‚‚ä»–ã‚’ç¶™ç¶š
      matrix:
        build-type: [android-apk, android-appbundle, web]

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup Flutter
      uses: subosito/flutter-action@v2
      with:
        flutter-version: ${{ env.FLUTTER_VERSION }}
        channel: 'stable'
        cache: true

    - name: Setup Java (Android builds)
      if: startsWith(matrix.build-type, 'android') && (github.base_ref == 'main' || github.ref_name == 'main')
      uses: actions/setup-java@v4
      with:
        distribution: 'zulu'
        java-version: '11'

    - name: Get dependencies
      env:
        APP_ENV: prod
        DATABASE_NAME: tech_lingual_quest.db
        API_BASE_URL: https://api.example.com
        LOG_LEVEL: error
      run: flutter pub get

    - name: Build Android APK
      if: matrix.build-type == 'android-apk' && (github.base_ref == 'main' || github.ref_name == 'main')
      run: |
        # Android APK å‘ã‘ã®ç’°å¢ƒå¤‰æ•°ã‚’è¨­å®š
        export APP_ENV=prod
        export DATABASE_NAME=tech_lingual_quest.db
        export API_BASE_URL=https://api.example.com
        # CIç’°å¢ƒã§ã®Gradleãƒ’ãƒ¼ãƒ—ã‚µã‚¤ã‚ºã‚’å¢—åŠ ï¼ˆãƒ­ãƒ¼ã‚«ãƒ«é–‹ç™ºã«ã¯å½±éŸ¿ã—ãªã„ï¼‰
        export GRADLE_OPTS="-Xmx4G -XX:MaxMetaspaceSize=1G -XX:ReservedCodeCacheSize=512m -XX:+HeapDumpOnOutOfMemoryError"
        flutter build apk --release
        echo "APK_PATH=$(find build/app/outputs/flutter-apk -name '*.apk' | head -1)" >> $GITHUB_ENV

    - name: Build Android App Bundle
      if: matrix.build-type == 'android-appbundle' && (github.base_ref == 'main' || github.ref_name == 'main')
      run: |
        # Android App Bundle å‘ã‘ã®ç’°å¢ƒå¤‰æ•°ã‚’è¨­å®š
        export APP_ENV=prod
        export DATABASE_NAME=tech_lingual_quest.db
        export API_BASE_URL=https://api.example.com
        export GRADLE_OPTS="-Xmx4G -XX:MaxMetaspaceSize=1G -XX:ReservedCodeCacheSize=512m -XX:+HeapDumpOnOutOfMemoryError"
        flutter build appbundle --release
        echo "AAB_PATH=$(find build/app/outputs/bundle -name '*.aab' | head -1)" >> $GITHUB_ENV

    - name: Build Web
      if: matrix.build-type == 'web'
      run: |
        # Web å‘ã‘ã®ç’°å¢ƒå¤‰æ•°ã‚’è¨­å®š
        export APP_ENV=prod
        export DATABASE_NAME=tech_lingual_quest.db
        export API_BASE_URL=https://api.example.com
        
        # Webç”¨ã®ä¾å­˜é–¢ä¿‚ã®ç¢ºèªã¨è¨­å®š
        echo "ğŸŒ Webãƒ“ãƒ«ãƒ‰ç”¨è¨­å®šã‚’ç¢ºèªä¸­..."
        
        # å¿…è¦ãªWebã‚¢ã‚»ãƒƒãƒˆã®ç¢ºèª
        echo "ğŸ“‚ Webã‚¢ã‚»ãƒƒãƒˆã®å­˜åœ¨ç¢ºèª..."
        if [ ! -f "web/favicon.png" ]; then
          echo "âš ï¸ favicon.png ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“"
          exit 1
        fi
        if [ ! -d "web/icons" ]; then
          echo "âš ï¸ web/icons ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“"
          exit 1
        fi
        
        # Webãƒ“ãƒ«ãƒ‰ã‚’å®Ÿè¡Œï¼ˆã‚¨ãƒ©ãƒ¼è©³ç´°ã‚’è¡¨ç¤ºï¼‰
        echo "ğŸš€ Webãƒ“ãƒ«ãƒ‰ã‚’é–‹å§‹..."
        flutter build web --release --verbose || {
          echo "âŒ Webãƒ“ãƒ«ãƒ‰ã«å¤±æ•—ã—ã¾ã—ãŸã€‚ã‚¯ãƒªãƒ¼ãƒ³ãƒ“ãƒ«ãƒ‰ã§å†è©¦è¡Œã—ã¾ã™..."
          flutter clean
          flutter pub get
          flutter build web --release --verbose
        }
        
        # ãƒ“ãƒ«ãƒ‰çµæœã®ç¢ºèª
        if [ -d "build/web" ]; then
          echo "âœ… Webãƒ“ãƒ«ãƒ‰æˆåŠŸ"
          echo "WEB_SIZE=$(du -sh build/web | cut -f1)" >> $GITHUB_ENV
          
          # é‡è¦ãªãƒ•ã‚¡ã‚¤ãƒ«ã®å­˜åœ¨ç¢ºèª
          if [ -f "build/web/index.html" ]; then
            echo "âœ… index.html ãŒç”Ÿæˆã•ã‚Œã¾ã—ãŸ"
          else
            echo "âš ï¸ è­¦å‘Š: index.html ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“"
          fi
          
          if [ -f "build/web/main.dart.js" ] || [ -f "build/web/main.dart.js.gz" ]; then
            echo "âœ… JavaScriptãƒ•ã‚¡ã‚¤ãƒ«ãŒç”Ÿæˆã•ã‚Œã¾ã—ãŸ"
          else
            echo "âš ï¸ è­¦å‘Š: main.dart.js ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“"
          fi
        else
          echo "âŒ build/web ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªãŒä½œæˆã•ã‚Œã¾ã›ã‚“ã§ã—ãŸ"
          exit 1
        fi

    - name: Upload Android APK artifact
      if: matrix.build-type == 'android-apk' && (github.base_ref == 'main' || github.ref_name == 'main')
      uses: actions/upload-artifact@v4
      with:
        name: android-apk
        path: build/app/outputs/flutter-apk/*.apk
        retention-days: 7

    - name: Upload Android App Bundle artifact
      if: matrix.build-type == 'android-appbundle' && (github.base_ref == 'main' || github.ref_name == 'main')
      uses: actions/upload-artifact@v4
      with:
        name: android-appbundle
        path: build/app/outputs/bundle/*/*.aab
        retention-days: 7

    - name: Upload Web build artifact
      if: matrix.build-type == 'web'
      uses: actions/upload-artifact@v4
      with:
        name: web-build
        path: build/web/
        retention-days: 7

  # å€‹åˆ¥é€šçŸ¥é€ä¿¡
  send-notifications:
    runs-on: ubuntu-latest
    name: Send Workflow Notifications
    needs: [quality-check, test, build]
    if: always()

    steps:
    - name: Determine workflow status
      id: status
      run: |
        # ã‚³ãƒŸãƒƒãƒˆSHAã®çŸ­ç¸®ç‰ˆã‚’ä½œæˆ
        SHORT_SHA=$(echo "${{ github.sha }}" | cut -c1-7)
        echo "short_sha=$SHORT_SHA" >> $GITHUB_OUTPUT
        
        QUALITY_CHECK="${{ needs.quality-check.result }}"
        TEST_RESULT="${{ needs.test.result }}"
        BUILD_RESULT="${{ needs.build.result }}"
        
        echo "ğŸ“Š ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼å®Ÿè¡Œçµæœ:"
        echo "Quality Check: $QUALITY_CHECK"
        echo "Test: $TEST_RESULT"
        echo "Build: $BUILD_RESULT"
        
        # å…¨ä½“ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã®åˆ¤å®š
        if [[ "$QUALITY_CHECK" == "success" && "$TEST_RESULT" == "success" && "$BUILD_RESULT" == "success" ]]; then
          OVERALL_STATUS="success"
          STATUS_EMOJI="âœ…"
          STATUS_COLOR="3066993"
          STATUS_MESSAGE="Flutter CI/CD ãƒ‘ã‚¤ãƒ—ãƒ©ã‚¤ãƒ³ãŒæ­£å¸¸ã«å®Œäº†ã—ã¾ã—ãŸ"
        else
          OVERALL_STATUS="failure"
          STATUS_EMOJI="âŒ"
          STATUS_COLOR="15158332"
          STATUS_MESSAGE="Flutter CI/CD ãƒ‘ã‚¤ãƒ—ãƒ©ã‚¤ãƒ³ã§ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ"
        fi
        
        echo "overall_status=$OVERALL_STATUS" >> $GITHUB_OUTPUT
        echo "status_emoji=$STATUS_EMOJI" >> $GITHUB_OUTPUT
        echo "status_color=$STATUS_COLOR" >> $GITHUB_OUTPUT
        echo "status_message=$STATUS_MESSAGE" >> $GITHUB_OUTPUT

    - name: Send Slack notification
      if: always() && vars.SLACK_WEBHOOK_URL
      run: |
        echo "ğŸ“¤ Slacké€šçŸ¥ã‚’é€ä¿¡ä¸­..."
        echo "   â”” é€šçŸ¥å†…å®¹: ${{ steps.status.outputs.status_message }}"
        
        # è©³ç´°çµæœã®æ§‹ç¯‰
        DETAIL_TEXT=""
        DETAIL_TEXT="${DETAIL_TEXT}*å„ã‚¹ãƒ†ãƒƒãƒ—ã®å®Ÿè¡Œçµæœ:*\n"
        DETAIL_TEXT="${DETAIL_TEXT}â€¢ ã‚³ãƒ¼ãƒ‰å“è³ªãƒã‚§ãƒƒã‚¯: ${{ needs.quality-check.result }}\n"
        DETAIL_TEXT="${DETAIL_TEXT}â€¢ ãƒ†ã‚¹ãƒˆå®Ÿè¡Œ: ${{ needs.test.result }}\n"
        DETAIL_TEXT="${DETAIL_TEXT}â€¢ ãƒ“ãƒ«ãƒ‰: ${{ needs.build.result }}\n\n"
        
        # Slacké€šçŸ¥é€ä¿¡
        curl -X POST -H 'Content-type: application/json' \
        --data '{
          "text": "${{ steps.status.outputs.status_emoji }} Flutter CI/CD å®Œäº†",
          "blocks": [
            {
              "type": "header",
              "text": {
                "type": "plain_text", 
                "text": "${{ steps.status.outputs.status_emoji }} TechLingual Quest Flutter CI/CD"
              }
            },
            {
              "type": "section",
              "text": {
                "type": "mrkdwn",
                "text": "${{ steps.status.outputs.status_message }}\n\n'"$DETAIL_TEXT"'"
              }
            },
            {
              "type": "section", 
              "fields": [
                {"type": "mrkdwn", "text": "*ãƒ–ãƒ©ãƒ³ãƒ:*\n${{ github.ref_name }}"},
                {"type": "mrkdwn", "text": "*ã‚³ãƒŸãƒƒãƒˆ:*\n${{ steps.status.outputs.short_sha }}"},
                {"type": "mrkdwn", "text": "*å®Ÿè¡Œè€…:*\n${{ github.actor }}"},
                {"type": "mrkdwn", "text": "*PRç•ªå·:*\n#${{ github.event.pull_request.number || 'N/A' }}"}
              ]
            },
            {
              "type": "actions",
              "elements": [
                {
                  "type": "button",
                  "text": {
                    "type": "plain_text",
                    "text": "ğŸ“Š è©³ç´°ã‚’GitHub Actionsã§ç¢ºèª"
                  },
                  "url": "https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}",
                  "style": "primary"
                }
              ]
            }
          ]
        }' \
        "${{ vars.SLACK_WEBHOOK_URL }}"
        
        SLACK_RESPONSE=$?
        if [ $SLACK_RESPONSE -eq 0 ]; then
          echo "âœ… Slacké€šçŸ¥ã®é€ä¿¡ãŒå®Œäº†ã—ã¾ã—ãŸ"
        else
          echo "âŒ Slacké€šçŸ¥ã®é€ä¿¡ã«å¤±æ•—ã—ã¾ã—ãŸ (çµ‚äº†ã‚³ãƒ¼ãƒ‰: $SLACK_RESPONSE)"
        fi

    - name: Send Discord notification
      if: always() && vars.DISCORD_WEBHOOK_URL
      run: |
        echo "ğŸ“¤ Discordé€šçŸ¥ã‚’é€ä¿¡ä¸­..."
        echo "   â”” é€šçŸ¥å†…å®¹: ${{ steps.status.outputs.status_message }}"
        
        curl -H "Content-Type: application/json" \
        -d '{
          "embeds": [{
            "title": "${{ steps.status.outputs.status_emoji }} Flutter CI/CD å®Œäº†",
            "description": "${{ steps.status.outputs.status_message }}",
            "color": ${{ steps.status.outputs.status_color }},
            "fields": [
              {"name": "ãƒ–ãƒ©ãƒ³ãƒ", "value": "${{ github.ref_name }}", "inline": true},
              {"name": "ã‚³ãƒŸãƒƒãƒˆ", "value": "${{ steps.status.outputs.short_sha }}", "inline": true},
              {"name": "å®Ÿè¡Œè€…", "value": "${{ github.actor }}", "inline": true},
              {"name": "å“è³ªãƒã‚§ãƒƒã‚¯", "value": "${{ needs.quality-check.result }}", "inline": true},
              {"name": "ãƒ†ã‚¹ãƒˆ", "value": "${{ needs.test.result }}", "inline": true},
              {"name": "ãƒ“ãƒ«ãƒ‰", "value": "${{ needs.build.result }}", "inline": true}
            ],
            "footer": {"text": "Flutter CI/CD Pipeline"},
            "timestamp": "'$(date -u +%Y-%m-%dT%H:%M:%S.000Z)'",
            "url": "https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}"
          }]
        }' \
        "${{ vars.DISCORD_WEBHOOK_URL }}"
        
        DISCORD_RESPONSE=$?
        if [ $DISCORD_RESPONSE -eq 0 ]; then
          echo "âœ… Discordé€šçŸ¥ã®é€ä¿¡ãŒå®Œäº†ã—ã¾ã—ãŸ"
        else
          echo "âŒ Discordé€šçŸ¥ã®é€ä¿¡ã«å¤±æ•—ã—ã¾ã—ãŸ (çµ‚äº†ã‚³ãƒ¼ãƒ‰: $DISCORD_RESPONSE)"
        fi
