name: Release Build

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:
    inputs:
      version:
        description: 'Release version (e.g., v1.0.0)'
        required: true
        default: 'v1.0.0'

env:
  FLUTTER_VERSION: '3.24.3'

jobs:
  # ãƒªãƒªãƒ¼ã‚¹å‰ã®æœ€çµ‚ãƒã‚§ãƒƒã‚¯
  pre-release-checks:
    runs-on: ubuntu-latest
    name: Pre-Release Quality Checks
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Setup Flutter
      uses: subosito/flutter-action@v2
      with:
        flutter-version: ${{ env.FLUTTER_VERSION }}
        channel: 'stable'
        cache: true
    
    - name: Get dependencies
      run: flutter pub get
    
    - name: Run all tests
      run: flutter test --coverage
    
    - name: Analyze code
      run: flutter analyze
    
    - name: Check formatting
      run: dart format --output=none --set-exit-if-changed .
    
    - name: Validate project structure
      run: ./validate_flutter_setup.sh

  # Android Release Build
  build-android:
    runs-on: ubuntu-latest
    name: Build Android Release
    needs: pre-release-checks
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Setup Flutter
      uses: subosito/flutter-action@v2
      with:
        flutter-version: ${{ env.FLUTTER_VERSION }}
        channel: 'stable'
        cache: true
    
    - name: Setup Java
      uses: actions/setup-java@v3
      with:
        distribution: 'zulu'
        java-version: '11'
    
    - name: Get dependencies
      run: flutter pub get
    
    - name: Build Android APK (Release)
      run: |
        flutter build apk --release
        echo "APK_PATH=$(find build/app/outputs/flutter-apk -name '*.apk' | head -1)" >> $GITHUB_ENV
        echo "APK_SIZE=$(du -h build/app/outputs/flutter-apk/*.apk | cut -f1)" >> $GITHUB_ENV
    
    - name: Build Android App Bundle (Release)
      run: |
        flutter build appbundle --release
        echo "AAB_PATH=$(find build/app/outputs/bundle -name '*.aab' | head -1)" >> $GITHUB_ENV
        echo "AAB_SIZE=$(du -h build/app/outputs/bundle/*/*.aab | cut -f1)" >> $GITHUB_ENV
    
    - name: Upload Android Release APK
      uses: actions/upload-artifact@v3
      with:
        name: android-release-apk
        path: build/app/outputs/flutter-apk/*.apk
        retention-days: 30
    
    - name: Upload Android Release Bundle
      uses: actions/upload-artifact@v3
      with:
        name: android-release-bundle
        path: build/app/outputs/bundle/*/*.aab
        retention-days: 30

  # Web Release Build
  build-web:
    runs-on: ubuntu-latest
    name: Build Web Release
    needs: pre-release-checks
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Setup Flutter
      uses: subosito/flutter-action@v2
      with:
        flutter-version: ${{ env.FLUTTER_VERSION }}
        channel: 'stable'
        cache: true
    
    - name: Get dependencies
      run: flutter pub get
    
    - name: Build Web (Release)
      run: |
        flutter build web --release --web-renderer canvaskit
        echo "WEB_SIZE=$(du -sh build/web | cut -f1)" >> $GITHUB_ENV
    
    - name: Upload Web Release
      uses: actions/upload-artifact@v3
      with:
        name: web-release
        path: build/web/
        retention-days: 30

  # ãƒªãƒªãƒ¼ã‚¹ãƒãƒ¼ãƒˆä½œæˆã¨GitHub Release
  create-release:
    runs-on: ubuntu-latest
    name: Create GitHub Release
    needs: [pre-release-checks, build-android, build-web]
    if: startsWith(github.ref, 'refs/tags/')
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
    
    - name: Get version from tag
      id: version
      run: |
        VERSION=${GITHUB_REF#refs/tags/}
        echo "version=$VERSION" >> $GITHUB_OUTPUT
        echo "version_number=${VERSION#v}" >> $GITHUB_OUTPUT
    
    - name: Generate release notes
      id: release_notes
      run: |
        # å‰å›ã®ã‚¿ã‚°ã‚’å–å¾—
        PREVIOUS_TAG=$(git describe --tags --abbrev=0 HEAD^ 2>/dev/null || echo "")
        
        if [ -n "$PREVIOUS_TAG" ]; then
          echo "changelog<<EOF" >> $GITHUB_OUTPUT
          echo "## ğŸš€ æ–°æ©Ÿèƒ½ã¨æ”¹å–„" >> $GITHUB_OUTPUT
          echo "" >> $GITHUB_OUTPUT
          git log --pretty=format:"- %s" $PREVIOUS_TAG..HEAD --grep="feat" >> $GITHUB_OUTPUT
          echo "" >> $GITHUB_OUTPUT
          echo "## ğŸ› ãƒã‚°ä¿®æ­£" >> $GITHUB_OUTPUT
          echo "" >> $GITHUB_OUTPUT
          git log --pretty=format:"- %s" $PREVIOUS_TAG..HEAD --grep="fix" >> $GITHUB_OUTPUT
          echo "" >> $GITHUB_OUTPUT
          echo "## ğŸ“š ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ" >> $GITHUB_OUTPUT
          echo "" >> $GITHUB_OUTPUT
          git log --pretty=format:"- %s" $PREVIOUS_TAG..HEAD --grep="docs" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT
        else
          echo "changelog=åˆå›ãƒªãƒªãƒ¼ã‚¹" >> $GITHUB_OUTPUT
        fi
    
    - name: Download Android APK
      uses: actions/download-artifact@v3
      with:
        name: android-release-apk
        path: ./release-assets/
    
    - name: Download Android Bundle
      uses: actions/download-artifact@v3
      with:
        name: android-release-bundle
        path: ./release-assets/
    
    - name: Download Web Release
      uses: actions/download-artifact@v3
      with:
        name: web-release
        path: ./web-release/
    
    - name: Create Web Release Archive
      run: |
        cd web-release
        zip -r ../release-assets/tech-lingual-quest-web-${{ steps.version.outputs.version }}.zip .
    
    - name: Create GitHub Release
      uses: actions/create-release@v1
      id: create_release
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      with:
        tag_name: ${{ steps.version.outputs.version }}
        release_name: TechLingual Quest ${{ steps.version.outputs.version }}
        body: |
          # TechLingual Quest ${{ steps.version.outputs.version }}
          
          ${{ steps.release_notes.outputs.changelog }}
          
          ## ğŸ“± ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰
          
          - **Android APK**: ã‚¹ãƒãƒ¼ãƒˆãƒ•ã‚©ãƒ³ãƒ»ã‚¿ãƒ–ãƒ¬ãƒƒãƒˆç”¨ï¼ˆGoogle Play å¤–ã§ã®é…å¸ƒï¼‰
          - **Android Bundle**: Google Play Store å‘ã‘é…å¸ƒç”¨
          - **Webç‰ˆ**: ãƒ–ãƒ©ã‚¦ã‚¶ã§å‹•ä½œã™ã‚‹ãƒãƒ¼ã‚¸ãƒ§ãƒ³
          
          ## ğŸ› ï¸ æŠ€è¡“ä»•æ§˜
          
          - Flutter SDK: ${{ env.FLUTTER_VERSION }}
          - å¯¾å¿œãƒ—ãƒ©ãƒƒãƒˆãƒ•ã‚©ãƒ¼ãƒ : Android 5.0+, iOS 11.0+, Web (Chrome, Firefox, Safari)
          - ãƒ“ãƒ«ãƒ‰æ—¥æ™‚: $(date '+%Y-%m-%d %H:%M:%S UTC')
        draft: false
        prerelease: false
    
    - name: Upload Android APK to Release
      uses: actions/upload-release-asset@v1
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      with:
        upload_url: ${{ steps.create_release.outputs.upload_url }}
        asset_path: ./release-assets/app-release.apk
        asset_name: tech-lingual-quest-${{ steps.version.outputs.version }}.apk
        asset_content_type: application/vnd.android.package-archive
    
    - name: Upload Web Release to Release
      uses: actions/upload-release-asset@v1
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      with:
        upload_url: ${{ steps.create_release.outputs.upload_url }}
        asset_path: ./release-assets/tech-lingual-quest-web-${{ steps.version.outputs.version }}.zip
        asset_name: tech-lingual-quest-web-${{ steps.version.outputs.version }}.zip
        asset_content_type: application/zip

  # ãƒªãƒªãƒ¼ã‚¹é€šçŸ¥
  notify-release:
    runs-on: ubuntu-latest
    name: Send Release Notifications
    needs: [create-release]
    if: always()
    
    steps:
    - name: Get version from tag
      id: version
      run: |
        VERSION=${GITHUB_REF#refs/tags/}
        echo "version=$VERSION" >> $GITHUB_OUTPUT
    
    - name: Send Discord release notification
      if: vars.DISCORD_WEBHOOK_URL
      run: |
        curl -H "Content-Type: application/json" \
        -d '{
          "embeds": [{
            "title": "ğŸ‰ TechLingual Quest æ–°ãƒãƒ¼ã‚¸ãƒ§ãƒ³ãƒªãƒªãƒ¼ã‚¹!",
            "description": "ãƒãƒ¼ã‚¸ãƒ§ãƒ³ ${{ steps.version.outputs.version }} ãŒãƒªãƒªãƒ¼ã‚¹ã•ã‚Œã¾ã—ãŸï¼",
            "color": 3447003,
            "fields": [
              {"name": "ãƒãƒ¼ã‚¸ãƒ§ãƒ³", "value": "${{ steps.version.outputs.version }}", "inline": true},
              {"name": "ãƒ—ãƒ©ãƒƒãƒˆãƒ•ã‚©ãƒ¼ãƒ ", "value": "Androidãƒ»Web", "inline": true},
              {"name": "Flutter SDK", "value": "${{ env.FLUTTER_VERSION }}", "inline": true}
            ],
            "footer": {"text": "GitHub Releases"},
            "timestamp": "'$(date -u +%Y-%m-%dT%H:%M:%S.000Z)'",
            "url": "https://github.com/${{ github.repository }}/releases/tag/${{ steps.version.outputs.version }}"
          }]
        }' \
        ${{ vars.DISCORD_WEBHOOK_URL }}
    
    - name: Send Slack release notification
      if: vars.SLACK_WEBHOOK_URL
      run: |
        curl -X POST -H 'Content-type: application/json' \
        --data '{
          "text": "ğŸ‰ TechLingual Quest æ–°ãƒãƒ¼ã‚¸ãƒ§ãƒ³ãƒªãƒªãƒ¼ã‚¹!",
          "blocks": [
            {
              "type": "header",
              "text": {
                "type": "plain_text",
                "text": "ğŸ‰ TechLingual Quest ${{ steps.version.outputs.version }}"
              }
            },
            {
              "type": "section",
              "text": {
                "type": "mrkdwn",
                "text": "æ–°ã—ã„ãƒãƒ¼ã‚¸ãƒ§ãƒ³ãŒãƒªãƒªãƒ¼ã‚¹ã•ã‚Œã¾ã—ãŸï¼Android APK ã¨ Webç‰ˆ ãŒåˆ©ç”¨å¯èƒ½ã§ã™ã€‚"
              }
            },
            {
              "type": "actions",
              "elements": [
                {
                  "type": "button",
                  "text": {
                    "type": "plain_text",
                    "text": "ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ãƒšãƒ¼ã‚¸ã‚’é–‹ã"
                  },
                  "url": "https://github.com/${{ github.repository }}/releases/tag/${{ steps.version.outputs.version }}"
                }
              ]
            }
          ]
        }' \
        ${{ vars.SLACK_WEBHOOK_URL }}