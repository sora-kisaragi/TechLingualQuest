name: CI/CD Summary Report

on:
  workflow_run:
    workflows: 
      - "Flutter CI/CD"
      - "Security Scan"
      - "Format Fix"
      - "Windows Build"
    types:
      - completed
  workflow_dispatch:
    inputs:
      manual_summary:
        description: 'æ‰‹å‹•ã§ã‚µãƒãƒªãƒ¼ãƒ¬ãƒãƒ¼ãƒˆã‚’ç”Ÿæˆ'
        required: false
        default: 'false'
      force_notifications:
        description: 'é€šçŸ¥ã‚’å¼·åˆ¶é€ä¿¡'
        required: false
        default: 'true'
        type: boolean

permissions:
  contents: read
  actions: read

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: false

jobs:
  collect-results:
    runs-on: ubuntu-latest
    name: Collect CI/CD Results
    if: github.event.workflow_run.event == 'pull_request' || github.event_name == 'workflow_dispatch'
    steps:
    - name: Wait for parallel workflows
      if: github.event_name == 'workflow_run'
      run: |
        # ä»–ã®ä¸¦åˆ—ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ã®å®Œäº†ã‚’å¾…æ©Ÿï¼ˆæœ€å¤§10åˆ†ï¼‰
        echo "â³ ä»–ã®CI/CDãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ã®å®Œäº†ã‚’å¾…æ©Ÿä¸­..."
        sleep 60  # åŸºæœ¬çš„ãªå¾…æ©Ÿæ™‚é–“

    - name: Get workflow run results
      id: get_results
      run: |
        # PRã®æœ€æ–°ã®ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼å®Ÿè¡Œçµæœã‚’å–å¾—
        if [ "${{ github.event_name }}" == "workflow_run" ]; then
          PR_NUMBER="${{ github.event.workflow_run.pull_requests[0].number || 'unknown' }}"
          COMMIT_SHA="${{ github.event.workflow_run.head_sha }}"
          BRANCH_NAME="${{ github.event.workflow_run.head_branch }}"
          ACTOR="${{ github.event.workflow_run.actor.login }}"
          REPO="${{ github.event.workflow_run.repository.full_name }}"
        else
          PR_NUMBER="manual"
          COMMIT_SHA="${{ github.sha }}"
          BRANCH_NAME="${{ github.ref_name }}"
          ACTOR="${{ github.actor }}"
          REPO="${{ github.repository }}"
        fi
        
        echo "pr_number=$PR_NUMBER" >> $GITHUB_OUTPUT
        echo "commit_sha=$(echo $COMMIT_SHA | cut -c1-7)" >> $GITHUB_OUTPUT
        echo "branch_name=$BRANCH_NAME" >> $GITHUB_OUTPUT
        echo "actor=$ACTOR" >> $GITHUB_OUTPUT
        echo "repo=$REPO" >> $GITHUB_OUTPUT
        
        # GitHub APIçµŒç”±ã§åŒä¸€ã‚³ãƒŸãƒƒãƒˆã®æœ€æ–°ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼çµæœã‚’å–å¾—ï¼ˆç°¡æ˜“ç‰ˆï¼‰
        echo "flutter_status=unknown" >> $GITHUB_OUTPUT
        echo "security_status=unknown" >> $GITHUB_OUTPUT
        echo "format_status=unknown" >> $GITHUB_OUTPUT
        echo "windows_status=unknown" >> $GITHUB_OUTPUT
        
        # ãƒˆãƒªã‚¬ãƒ¼ã¨ãªã£ãŸãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ã®çµæœã‚’è¨­å®š
        if [ "${{ github.event_name }}" == "workflow_run" ]; then
          TRIGGERED_WORKFLOW="${{ github.event.workflow_run.name }}"
          TRIGGERED_STATUS="${{ github.event.workflow_run.conclusion }}"
          
          case "$TRIGGERED_WORKFLOW" in
            "Flutter CI/CD")
              echo "flutter_status=$TRIGGERED_STATUS" >> $GITHUB_OUTPUT
              ;;
            "Security Scan")
              echo "security_status=$TRIGGERED_STATUS" >> $GITHUB_OUTPUT
              ;;
            "Format Fix")
              echo "format_status=$TRIGGERED_STATUS" >> $GITHUB_OUTPUT
              ;;
            "Windows Build")
              echo "windows_status=$TRIGGERED_STATUS" >> $GITHUB_OUTPUT
              ;;
          esac
        fi

    - name: Evaluate overall status
      id: evaluate
      run: |
        # å„ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ã®ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã‚’è©•ä¾¡
        FLUTTER_STATUS="${{ steps.get_results.outputs.flutter_status }}"
        SECURITY_STATUS="${{ steps.get_results.outputs.security_status }}"  
        FORMAT_STATUS="${{ steps.get_results.outputs.format_status }}"
        WINDOWS_STATUS="${{ steps.get_results.outputs.windows_status }}"
        
        echo "Flutter CI/CD: $FLUTTER_STATUS"
        echo "Security Scan: $SECURITY_STATUS"
        echo "Format Fix: $FORMAT_STATUS"
        echo "Windows Build: $WINDOWS_STATUS"
        
        # æˆåŠŸãƒ»å¤±æ•—ãƒ»ä¸æ˜ã®åˆ†é¡
        SUCCESS_COUNT=0
        FAILURE_COUNT=0
        UNKNOWN_COUNT=0
        
        for status in "$FLUTTER_STATUS" "$SECURITY_STATUS" "$FORMAT_STATUS" "$WINDOWS_STATUS"; do
          case "$status" in
            "success") ((SUCCESS_COUNT++)) ;;
            "failure") ((FAILURE_COUNT++)) ;;
            *) ((UNKNOWN_COUNT++)) ;;
          esac
        done
        
        # å…¨ä½“ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã®æ±ºå®š
        if [ $FAILURE_COUNT -gt 0 ]; then
          OVERALL_STATUS="failure"
          STATUS_EMOJI="âŒ"
          STATUS_COLOR="15158332"
          STATUS_MESSAGE="CI/CDãƒ‘ã‚¤ãƒ—ãƒ©ã‚¤ãƒ³ã§ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ"
        elif [ $UNKNOWN_COUNT -gt 0 ]; then
          OVERALL_STATUS="partial"  
          STATUS_EMOJI="âš ï¸"
          STATUS_COLOR="16776960"
          STATUS_MESSAGE="CI/CDãƒ‘ã‚¤ãƒ—ãƒ©ã‚¤ãƒ³ã®ä¸€éƒ¨ãŒå®Ÿè¡Œä¸­ã¾ãŸã¯çµæœä¸æ˜ã§ã™"
        else
          OVERALL_STATUS="success"
          STATUS_EMOJI="âœ…"  
          STATUS_COLOR="3066993"
          STATUS_MESSAGE="å…¨ã¦ã®CI/CDãƒ‘ã‚¤ãƒ—ãƒ©ã‚¤ãƒ³ãŒæ­£å¸¸ã«å®Œäº†ã—ã¾ã—ãŸ"
        fi
        
        echo "overall_status=$OVERALL_STATUS" >> $GITHUB_OUTPUT
        echo "status_emoji=$STATUS_EMOJI" >> $GITHUB_OUTPUT
        echo "status_color=$STATUS_COLOR" >> $GITHUB_OUTPUT
        echo "status_message=$STATUS_MESSAGE" >> $GITHUB_OUTPUT
        echo "success_count=$SUCCESS_COUNT" >> $GITHUB_OUTPUT
        echo "failure_count=$FAILURE_COUNT" >> $GITHUB_OUTPUT
        echo "unknown_count=$UNKNOWN_COUNT" >> $GITHUB_OUTPUT
        
        # å®Ÿè¡Œæ™‚é–“ã‚’æ¨å®š
        echo "estimated_duration=ç´„5åˆ†" >> $GITHUB_OUTPUT

    - name: Send unified Slack notification
      if: always() && vars.SLACK_WEBHOOK_URL
      run: |
        # è©³ç´°ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹æƒ…å ±ã®æ§‹ç¯‰
        DETAIL_BLOCKS=""
        
        # å„ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ã®è©³ç´°çŠ¶æ³
        STATUS_DETAILS="*å„ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ã®å®Ÿè¡Œçµæœ:*\n"
        STATUS_DETAILS="${STATUS_DETAILS}â€¢ Flutter CI/CD: ${{ steps.get_results.outputs.flutter_status }}\n"
        STATUS_DETAILS="${STATUS_DETAILS}â€¢ Security Scan: ${{ steps.get_results.outputs.security_status }}\n"
        STATUS_DETAILS="${STATUS_DETAILS}â€¢ Format Fix: ${{ steps.get_results.outputs.format_status }}\n"
        STATUS_DETAILS="${STATUS_DETAILS}â€¢ Windows Build: ${{ steps.get_results.outputs.windows_status }}\n\n"
        
        if [ "${{ steps.evaluate.outputs.overall_status }}" != "success" ]; then
          if [ "${{ steps.evaluate.outputs.failure_count }}" -gt 0 ]; then
            STATUS_DETAILS="${STATUS_DETAILS}*å¯¾å¿œãŒå¿…è¦:* ${{ steps.evaluate.outputs.failure_count }}å€‹ã®ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ã§å•é¡ŒãŒç™ºç”Ÿ\n"
          fi
          if [ "${{ steps.evaluate.outputs.unknown_count }}" -gt 0 ]; then
            STATUS_DETAILS="${STATUS_DETAILS}*ç¢ºèªè¦:* ${{ steps.evaluate.outputs.unknown_count }}å€‹ã®ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ã®çµæœãŒä¸æ˜\n"
          fi
        else
          STATUS_DETAILS="${STATUS_DETAILS}*çµæœ:* å…¨${{ steps.evaluate.outputs.success_count }}å€‹ã®ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ãŒæ­£å¸¸å®Œäº† âœ…"
        fi
        
        # GitHub Actionsã®è©³ç´°ã¸ã®ãƒªãƒ³ã‚¯
        ACTIONS_URL="https://github.com/${{ steps.get_results.outputs.repo }}/actions"
        
        # Slacké€šçŸ¥é€ä¿¡
        curl -X POST -H 'Content-type: application/json' \
        --data '{
          "text": "${{ steps.evaluate.outputs.status_emoji }} TechLingual Quest CI/CD çµ±åˆãƒ¬ãƒãƒ¼ãƒˆ",
          "blocks": [
            {
              "type": "header",
              "text": {
                "type": "plain_text", 
                "text": "${{ steps.evaluate.outputs.status_emoji }} TechLingual Quest CI/CD çµ±åˆãƒ¬ãƒãƒ¼ãƒˆ"
              }
            },
            {
              "type": "section",
              "text": {
                "type": "mrkdwn",
                "text": "${{ steps.evaluate.outputs.status_message }}\n\n'"$STATUS_DETAILS"'"
              }
            },
            {
              "type": "section", 
              "fields": [
                {"type": "mrkdwn", "text": "*PR/ãƒ–ãƒ©ãƒ³ãƒ:*\n#${{ steps.get_results.outputs.pr_number }} (${{ steps.get_results.outputs.branch_name }})"},
                {"type": "mrkdwn", "text": "*ã‚³ãƒŸãƒƒãƒˆ:*\n${{ steps.get_results.outputs.commit_sha }}"},
                {"type": "mrkdwn", "text": "*å®Ÿè¡Œè€…:*\n${{ steps.get_results.outputs.actor }}"},
                {"type": "mrkdwn", "text": "*å®Ÿè¡Œæ™‚é–“:*\n${{ steps.evaluate.outputs.estimated_duration }}"}
              ]
            },
            {
              "type": "actions",
              "elements": [
                {
                  "type": "button",
                  "text": {
                    "type": "plain_text",
                    "text": "ğŸ“Š GitHub Actions ã§è©³ç´°ç¢ºèª"
                  },
                  "url": "'"$ACTIONS_URL"'",
                  "style": "primary"
                },
                {
                  "type": "button",
                  "text": {
                    "type": "plain_text",
                    "text": "ğŸ“¦ ãƒ“ãƒ«ãƒ‰æˆæœç‰©ã‚’ç¢ºèª"
                  },
                  "url": "'"$ACTIONS_URL"'"
                }
              ]
            }
          ]
        }' \
        ${{ vars.SLACK_WEBHOOK_URL }}

    - name: Send unified Discord notification
      if: always() && vars.DISCORD_WEBHOOK_URL  
      run: |
        # GitHub Actionsã®è©³ç´°ã¸ã®ãƒªãƒ³ã‚¯
        ACTIONS_URL="https://github.com/${{ steps.get_results.outputs.repo }}/actions"
        
        # å¤±æ•—è©³ç´°ã®æ§‹ç¯‰
        FAILURE_DETAILS=""
        if [ "${{ steps.get_results.outputs.flutter_status }}" == "failure" ]; then
          FAILURE_DETAILS="${FAILURE_DETAILS}â€¢ Flutter CI/CD: ãƒ†ã‚¹ãƒˆãƒ»ãƒ“ãƒ«ãƒ‰ã‚¨ãƒ©ãƒ¼\n"
        fi
        if [ "${{ steps.get_results.outputs.security_status }}" == "failure" ]; then
          FAILURE_DETAILS="${FAILURE_DETAILS}â€¢ Security Scan: è„†å¼±æ€§æ¤œå‡º\n"  
        fi
        if [ "${{ steps.get_results.outputs.format_status }}" == "failure" ]; then
          FAILURE_DETAILS="${FAILURE_DETAILS}â€¢ Format Fix: ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆã‚¨ãƒ©ãƒ¼\n"
        fi
        if [ "${{ steps.get_results.outputs.windows_status }}" == "failure" ]; then
          FAILURE_DETAILS="${FAILURE_DETAILS}â€¢ Windows Build: ãƒ“ãƒ«ãƒ‰ã‚¨ãƒ©ãƒ¼\n"
        fi
        
        DESCRIPTION_TEXT="${{ steps.evaluate.outputs.status_message }}"
        if [ -n "$FAILURE_DETAILS" ]; then
          DESCRIPTION_TEXT="${DESCRIPTION_TEXT}\n\n**å¤±æ•—è©³ç´°:**\n${FAILURE_DETAILS}"
        fi
        
        curl -H "Content-Type: application/json" \
        -d '{
          "embeds": [{
            "title": "ğŸ”„ TechLingual Quest CI/CD çµ±åˆãƒ¬ãƒãƒ¼ãƒˆ",
            "description": "'"$DESCRIPTION_TEXT"'",
            "color": ${{ steps.evaluate.outputs.status_color }},
            "fields": [
              {"name": "PRç•ªå·", "value": "#${{ steps.get_results.outputs.pr_number }}", "inline": true},
              {"name": "ãƒ–ãƒ©ãƒ³ãƒ", "value": "${{ steps.get_results.outputs.branch_name }}", "inline": true},
              {"name": "ã‚³ãƒŸãƒƒãƒˆ", "value": "${{ steps.get_results.outputs.commit_sha }}", "inline": true},
              {"name": "Flutter CI/CD", "value": "${{ steps.get_results.outputs.flutter_status }}", "inline": true},
              {"name": "Security Scan", "value": "${{ steps.get_results.outputs.security_status }}", "inline": true},
              {"name": "Format Fix", "value": "${{ steps.get_results.outputs.format_status }}", "inline": true},
              {"name": "Windows Build", "value": "${{ steps.get_results.outputs.windows_status }}", "inline": true},
              {"name": "å®Ÿè¡Œè€…", "value": "${{ steps.get_results.outputs.actor }}", "inline": true}
            ],
            "footer": {"text": "GitHub Actions çµ±åˆãƒ¬ãƒãƒ¼ãƒˆ"},
            "timestamp": "'$(date -u +%Y-%m-%dT%H:%M:%S.000Z)'",
            "url": "'"$ACTIONS_URL"'"
          }]
        }' \
        ${{ vars.DISCORD_WEBHOOK_URL }}

    - name: Summary report
      run: |
        echo "ğŸ“Š CI/CDçµ±åˆãƒ¬ãƒãƒ¼ãƒˆç”Ÿæˆå®Œäº†"
        echo "============================================="
        echo "å…¨ä½“ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹: ${{ steps.evaluate.outputs.overall_status }}"
        echo "æˆåŠŸ: ${{ steps.evaluate.outputs.success_count }}å€‹"
        echo "å¤±æ•—: ${{ steps.evaluate.outputs.failure_count }}å€‹" 
        echo "ä¸æ˜: ${{ steps.evaluate.outputs.unknown_count }}å€‹"
        echo "============================================="
        echo "${{ steps.evaluate.outputs.status_message }}"