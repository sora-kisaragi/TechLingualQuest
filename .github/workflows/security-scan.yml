name: Security Scan

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]
  schedule:
    # æ¯æ—¥åˆå‰2æ™‚ï¼ˆUTCï¼‰ã«ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã‚¹ã‚­ãƒ£ãƒ³ã‚’å®Ÿè¡Œ
    - cron: '0 2 * * *'

permissions:
  contents: read
  security-events: write
  actions: read

jobs:
  security-scan:
    runs-on: ubuntu-latest
    name: Security Vulnerability Scan
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Setup Flutter
      uses: subosito/flutter-action@v2
      with:
        flutter-version: '3.24.3'
        channel: 'stable'
        cache: true
    
    - name: Get dependencies
      run: flutter pub get
    
    - name: Run dependency audit
      run: |
        # Flutter/Dartä¾å­˜é–¢ä¿‚ã®è„†å¼±æ€§ãƒã‚§ãƒƒã‚¯
        dart pub deps --json > deps.json
        if command -v jq &> /dev/null; then
          echo "ğŸ“¦ ä¾å­˜é–¢ä¿‚åˆ†æçµæœ:"
          jq '.packages[] | select(.kind == "direct") | {name: .name, version: .version}' deps.json
        fi
        
        # pubspec.lock ã®å†…å®¹ã‚’ãƒã‚§ãƒƒã‚¯
        if [ -f "pubspec.lock" ]; then
          echo "ğŸ”’ ãƒ­ãƒƒã‚¯ãƒ•ã‚¡ã‚¤ãƒ«ç¢ºèª: pubspec.lock ãŒå­˜åœ¨ã—ã¾ã™"
        else
          echo "âš ï¸ è­¦å‘Š: pubspec.lock ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“"
        fi
        
        # æ—¢çŸ¥ã®è„†å¼±æ€§ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã®ãƒã‚§ãƒƒã‚¯ï¼ˆä¾‹ï¼‰
        if grep -q "vulnerable_package" pubspec.yaml; then
          echo "ğŸš¨ å±é™º: æ—¢çŸ¥ã®è„†å¼±æ€§ã‚’æŒã¤ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ãŒæ¤œå‡ºã•ã‚Œã¾ã—ãŸ"
          exit 1
        fi
    
    - name: CodeQL Analysis
      uses: github/codeql-action/init@v3
      with:
        languages: dart
        queries: security-extended
    
    - name: Perform CodeQL Analysis
      uses: github/codeql-action/analyze@v3
    
    - name: Upload security scan results
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: security-scan-results
        path: |
          deps.json
          pubspec.lock
        retention-days: 30
    
    - name: Send security notification
      if: failure() && (vars.DISCORD_WEBHOOK_URL || vars.SLACK_WEBHOOK_URL)
      run: |
        if [ -n "${{ vars.DISCORD_WEBHOOK_URL }}" ]; then
          curl -H "Content-Type: application/json" \
          -d '{
            "embeds": [{
              "title": "ğŸš¨ ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã‚¹ã‚­ãƒ£ãƒ³è­¦å‘Š",
              "description": "TechLingual Questãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã§ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ä¸Šã®å•é¡ŒãŒæ¤œå‡ºã•ã‚Œã¾ã—ãŸ",
              "color": 16711680,
              "fields": [
                {"name": "ãƒ–ãƒ©ãƒ³ãƒ", "value": "${{ github.ref_name }}", "inline": true},
                {"name": "ã‚³ãƒŸãƒƒãƒˆ", "value": "$(echo ${{ github.sha }} | cut -c1-7)", "inline": true},
                {"name": "å®Ÿè¡Œè€…", "value": "${{ github.actor }}", "inline": true}
              ],
              "footer": {"text": "ç·Šæ€¥å¯¾å¿œãŒå¿…è¦ã§ã™"},
              "timestamp": "'$(date -u +%Y-%m-%dT%H:%M:%S.000Z)'",
              "url": "https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}"
            }]
          }' \
          ${{ vars.DISCORD_WEBHOOK_URL }}
        fi
        
        if [ -n "${{ vars.SLACK_WEBHOOK_URL }}" ]; then
          curl -X POST -H 'Content-type: application/json' \
          --data '{
            "text": "ğŸš¨ ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã‚¹ã‚­ãƒ£ãƒ³è­¦å‘Š",
            "blocks": [
              {
                "type": "header",
                "text": {
                  "type": "plain_text",
                  "text": "ğŸš¨ ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã‚¹ã‚­ãƒ£ãƒ³è­¦å‘Š"
                }
              },
              {
                "type": "section",
                "text": {
                  "type": "mrkdwn",
                  "text": "TechLingual Questãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã§ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ä¸Šã®å•é¡ŒãŒæ¤œå‡ºã•ã‚Œã¾ã—ãŸã€‚ç·Šæ€¥å¯¾å¿œãŒå¿…è¦ã§ã™ã€‚"
                }
              }
            ]
          }' \
          ${{ vars.SLACK_WEBHOOK_URL }}
        fi