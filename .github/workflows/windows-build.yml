name: Windows Build

on:
  push:
    branches: [ develop ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:

permissions:
  contents: read
  actions: read

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

env:
  FLUTTER_VERSION: '3.35.2'

jobs:
  build-windows:
    runs-on: windows-latest
    name: Build Windows Application
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup Flutter
      uses: subosito/flutter-action@v2
      with:
        flutter-version: ${{ env.FLUTTER_VERSION }}
        channel: 'stable'
        cache: true

    - name: Enable Windows desktop
      run: flutter config --enable-windows-desktop

    - name: Get dependencies
      env:
        APP_ENV: prod
        DATABASE_NAME: tech_lingual_quest.db
        API_BASE_URL: https://api.example.com
        LOG_LEVEL: error
      run: flutter pub get

    - name: Build Windows (Release)
      run: |
        $env:APP_ENV="prod"
        $env:DATABASE_NAME="tech_lingual_quest.db"
        $env:API_BASE_URL="https://api.example.com"
        flutter build windows --release
        Write-Host "Windows build completed successfully"

    - name: Prepare Windows package
      id: package
      run: |
        # ãƒ“ãƒ«ãƒ‰æˆæœç‰©ã®ãƒ‘ã‚¹ã‚’ç¢ºèª
        $buildPath = "build\windows\x64\runner\Release"
        if (Test-Path $buildPath) {
          Write-Host "âœ… Build artifacts found at: $buildPath"
          
          # ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã‚’ä½œæˆ
          $packageDir = "windows-package"
          New-Item -ItemType Directory -Force -Path $packageDir
          
          # å¿…è¦ãªãƒ•ã‚¡ã‚¤ãƒ«ã‚’ã‚³ãƒ”ãƒ¼
          Copy-Item -Path "$buildPath\*" -Destination $packageDir -Recurse -Force
          
          # ã‚µã‚¤ã‚ºæƒ…å ±ã‚’å–å¾—
          $totalSize = (Get-ChildItem -Path $packageDir -Recurse | Measure-Object -Property Length -Sum).Sum
          $sizeInMB = [math]::Round($totalSize / 1MB, 2)
          
          Write-Host "Package size: $sizeInMB MB"
          
          # GitHub Actionsã®å‡ºåŠ›ã«è¨­å®š
          echo "package_path=$packageDir" >> $env:GITHUB_OUTPUT
          echo "package_size_mb=$sizeInMB" >> $env:GITHUB_OUTPUT
          
          # ãƒ•ã‚¡ã‚¤ãƒ«ä¸€è¦§ã‚’å‡ºåŠ›
          Write-Host "ğŸ“¦ Package contents:"
          Get-ChildItem -Path $packageDir -Recurse -File | ForEach-Object {
            Write-Host "  - $($_.Name) ($([math]::Round($_.Length / 1KB, 1)) KB)"
          }
        } else {
          Write-Host "âŒ Build artifacts not found"
          exit 1
        }

    - name: Create compressed archive
      id: compress
      run: |
        $packagePath = "${{ steps.package.outputs.package_path }}"
        $archiveName = "TechLingualQuest-Windows-${{ github.run_number }}.zip"
        
        # ZIPãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä½œæˆ
        Compress-Archive -Path "$packagePath\*" -DestinationPath $archiveName -Force
        
        if (Test-Path $archiveName) {
          $archiveSize = [math]::Round((Get-Item $archiveName).Length / 1MB, 2)
          Write-Host "âœ… Archive created: $archiveName ($archiveSize MB)"
          
          # GitHub Actionsã®å‡ºåŠ›ã«è¨­å®š
          echo "archive_name=$archiveName" >> $env:GITHUB_OUTPUT
          echo "archive_size_mb=$archiveSize" >> $env:GITHUB_OUTPUT
        } else {
          Write-Host "âŒ Failed to create archive"
          exit 1
        }

    - name: Upload Windows build artifact
      uses: actions/upload-artifact@v4
      with:
        name: windows-build
        path: ${{ steps.compress.outputs.archive_name }}
        retention-days: 7

    - name: Send Slack notification with build results
      if: vars.SLACK_WEBHOOK_URL
      run: |
        $status = "success"
        $emoji = ":white_check_mark:"
        $color = "#28a745"
        
        # Slackãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’é€ä¿¡
        $payload = @{
          text = "$emoji Windows ãƒ“ãƒ«ãƒ‰å®Œäº†"
          blocks = @(
            @{
              type = "header"
              text = @{
                type = "plain_text"
                text = "$emoji TechLingualQuest Windows ãƒ“ãƒ«ãƒ‰å®Œäº†"
              }
            },
            @{
              type = "section"
              text = @{
                type = "mrkdwn"
                text = "Windowsã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã®ãƒ“ãƒ«ãƒ‰ãŒæ­£å¸¸ã«å®Œäº†ã—ã¾ã—ãŸã€‚"
              }
            },
            @{
              type = "section"
              fields = @(
                @{
                  type = "mrkdwn"
                  text = "*ãƒ“ãƒ«ãƒ‰ç•ªå·:*`n${{ github.run_number }}"
                },
                @{
                  type = "mrkdwn"
                  text = "*ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã‚µã‚¤ã‚º:*`n${{ steps.package.outputs.package_size_mb }} MB"
                },
                @{
                  type = "mrkdwn"
                  text = "*åœ§ç¸®å¾Œã‚µã‚¤ã‚º:*`n${{ steps.compress.outputs.archive_size_mb }} MB"
                },
                @{
                  type = "mrkdwn"
                  text = "*ãƒ–ãƒ©ãƒ³ãƒ:*`n${{ github.ref_name }}"
                }
              )
            },
            @{
              type = "section"
              text = @{
                type = "mrkdwn"
                text = "*ğŸ“ æˆæœç‰©:*`nâ€¢ ${{ steps.compress.outputs.archive_name }}"
              }
            },
            @{
              type = "actions"
              elements = @(
                @{
                  type = "button"
                  text = @{
                    type = "plain_text"
                    text = "ã‚¢ãƒ¼ãƒ†ã‚£ãƒ•ã‚¡ã‚¯ãƒˆã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰"
                  }
                  url = "https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}"
                }
              )
            }
          )
        } | ConvertTo-Json -Depth 10
        
        try {
          Invoke-RestMethod -Uri "${{ vars.SLACK_WEBHOOK_URL }}" -Method Post -ContentType "application/json" -Body $payload
          Write-Host "âœ… Slack notification sent successfully"
        } catch {
          Write-Host "âš ï¸ Failed to send Slack notification: $($_.Exception.Message)"
        }

    - name: Send Discord notification with build results
      if: vars.DISCORD_WEBHOOK_URL
      run: |
        $payload = @{
          embeds = @(
            @{
              title = "ğŸ–¥ï¸ Windows ãƒ“ãƒ«ãƒ‰å®Œäº†"
              description = "TechLingualQuest Windowsã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã®ãƒ“ãƒ«ãƒ‰ãŒå®Œäº†ã—ã¾ã—ãŸ"
              color = 3066993
              fields = @(
                @{
                  name = "ãƒ“ãƒ«ãƒ‰ç•ªå·"
                  value = "${{ github.run_number }}"
                  inline = $true
                },
                @{
                  name = "ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã‚µã‚¤ã‚º"
                  value = "${{ steps.package.outputs.package_size_mb }} MB"
                  inline = $true
                },
                @{
                  name = "åœ§ç¸®å¾Œã‚µã‚¤ã‚º"
                  value = "${{ steps.compress.outputs.archive_size_mb }} MB"
                  inline = $true
                },
                @{
                  name = "æˆæœç‰©"
                  value = "${{ steps.compress.outputs.archive_name }}"
                  inline = $false
                }
              )
              footer = @{
                text = "GitHub Actions"
              }
              timestamp = (Get-Date).ToUniversalTime().ToString("yyyy-MM-ddTHH:mm:ss.fffZ")
              url = "https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}"
            }
          )
        } | ConvertTo-Json -Depth 10
        
        try {
          Invoke-RestMethod -Uri "${{ vars.DISCORD_WEBHOOK_URL }}" -Method Post -ContentType "application/json" -Body $payload
          Write-Host "âœ… Discord notification sent successfully"
        } catch {
          Write-Host "âš ï¸ Failed to send Discord notification: $($_.Exception.Message)"
        }

  notify-failure:
    runs-on: ubuntu-latest
    name: Notify Build Failure
    needs: [build-windows]
    if: failure()
    
    steps:
    - name: Send failure notification
      if: vars.SLACK_WEBHOOK_URL || vars.DISCORD_WEBHOOK_URL
      run: |
        if [ -n "${{ vars.SLACK_WEBHOOK_URL }}" ]; then
          curl -X POST -H 'Content-type: application/json' \
          --data '{
            "text": "âŒ Windows ãƒ“ãƒ«ãƒ‰å¤±æ•—",
            "blocks": [
              {
                "type": "header",
                "text": {
                  "type": "plain_text",
                  "text": "âŒ TechLingualQuest Windows ãƒ“ãƒ«ãƒ‰å¤±æ•—"
                }
              },
              {
                "type": "section",
                "text": {
                  "type": "mrkdwn",
                  "text": "Windowsã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã®ãƒ“ãƒ«ãƒ‰ã«å¤±æ•—ã—ã¾ã—ãŸã€‚è©³ç´°ãªåŸå› ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚"
                }
              },
              {
                "type": "section",
                "fields": [
                  {"type": "mrkdwn", "text": "*å¤±æ•—ã‚¸ãƒ§ãƒ–:*\nWindows Build"},
                  {"type": "mrkdwn", "text": "*ãƒ–ãƒ©ãƒ³ãƒ:*\n${{ github.ref_name }}"},
                  {"type": "mrkdwn", "text": "*å®Ÿè¡Œè€…:*\n${{ github.actor }}"},
                  {"type": "mrkdwn", "text": "*ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼:*\nWindows Build CI/CD"}
                ]
              },
              {
                "type": "actions",
                "elements": [
                  {
                    "type": "button",
                    "text": {
                      "type": "plain_text",
                      "text": "ãƒ­ã‚°ã‚’ç¢ºèª"
                    },
                    "url": "https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}"
                  }
                ]
              }
            ]
          }' \
          ${{ vars.SLACK_WEBHOOK_URL }}
        fi

        if [ -n "${{ vars.DISCORD_WEBHOOK_URL }}" ]; then
          curl -H "Content-Type: application/json" \
          -d '{
            "embeds": [{
              "title": "âŒ Windows ãƒ“ãƒ«ãƒ‰å¤±æ•—",
              "description": "TechLingualQuest Windowsã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã®ãƒ“ãƒ«ãƒ‰ã«å¤±æ•—ã—ã¾ã—ãŸ",
              "color": 15158332,
              "fields": [
                {"name": "å¤±æ•—ã‚¸ãƒ§ãƒ–", "value": "Windows Build", "inline": true},
                {"name": "ãƒ–ãƒ©ãƒ³ãƒ", "value": "${{ github.ref_name }}", "inline": true},
                {"name": "å®Ÿè¡Œè€…", "value": "${{ github.actor }}", "inline": true}
              ],
              "footer": {"text": "ç·Šæ€¥å¯¾å¿œãŒå¿…è¦ã§ã™"},
              "timestamp": "'$(date -u +%Y-%m-%dT%H:%M:%S.000Z)'",
              "url": "https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}"
            }]
          }' \
          ${{ vars.DISCORD_WEBHOOK_URL }}
        fi