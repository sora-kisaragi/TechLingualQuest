name: Format Fix

on:
  pull_request:
    branches: [ main, develop ]
  workflow_dispatch:

permissions:
  contents: write
  actions: read

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

env:
  FLUTTER_VERSION: '3.24.5'

jobs:
  format-check-and-fix:
    runs-on: ubuntu-latest
    name: Format Check & Auto Fix
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        token: ${{ secrets.GITHUB_TOKEN }}

    - name: Setup Flutter
      uses: subosito/flutter-action@v2
      with:
        flutter-version: ${{ env.FLUTTER_VERSION }}
        channel: 'stable'
        cache: true

    - name: Get dependencies
      env:
        APP_ENV: dev
        DATABASE_NAME: tech_lingual_quest_test.db
        API_BASE_URL: https://api.example.com
        LOG_LEVEL: error
      run: flutter pub get

    - name: Check formatting (Investigation)
      id: check_format
      run: |
        echo "ğŸ” ã‚³ãƒ¼ãƒ‰ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆã®èª¿æŸ»ã‚’é–‹å§‹..."
        if dart format --output=none --set-exit-if-changed .; then
          echo "format_needed=false" >> $GITHUB_OUTPUT
          echo "âœ… ã‚³ãƒ¼ãƒ‰ã¯æ—¢ã«é©åˆ‡ã«ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆã•ã‚Œã¦ã„ã¾ã™"
        else
          echo "format_needed=true" >> $GITHUB_OUTPUT
          echo "ğŸ”§ ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆä¿®æ­£ãŒå¿…è¦ãªãƒ•ã‚¡ã‚¤ãƒ«ãŒè¦‹ã¤ã‹ã‚Šã¾ã—ãŸ"
        fi

    - name: Apply formatting fixes
      if: steps.check_format.outputs.format_needed == 'true'
      run: |
        echo "ğŸ”§ ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆä¿®æ­£ã‚’å®Ÿè¡Œä¸­..."
        dart format .
        echo "âœ… ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆä¿®æ­£ãŒå®Œäº†ã—ã¾ã—ãŸ"

    - name: Generate fix report
      if: steps.check_format.outputs.format_needed == 'true'
      id: fix_report
      run: |
        echo "ğŸ“‹ ä¿®æ­£å†…å®¹ã®ãƒ¬ãƒãƒ¼ãƒˆã‚’ç”Ÿæˆä¸­..."
        CHANGED_FILES=$(git diff --name-only | grep '\.dart$' || echo "å¤‰æ›´ãƒ•ã‚¡ã‚¤ãƒ«ãªã—")
        TOTAL_CHANGES=$(git diff --numstat | wc -l)
        
        if [ "$TOTAL_CHANGES" -gt 0 ]; then
          echo "changes_made=true" >> $GITHUB_OUTPUT
          echo "changed_files<<EOF" >> $GITHUB_OUTPUT
          echo "$CHANGED_FILES" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT
          echo "total_changes=$TOTAL_CHANGES" >> $GITHUB_OUTPUT
          
          # å¤‰æ›´ã®è©³ç´°ã‚’ãƒ­ã‚°ã«å‡ºåŠ›
          echo "ğŸ“ ä¿®æ­£ã•ã‚ŒãŸãƒ•ã‚¡ã‚¤ãƒ«:"
          git diff --name-only | grep '\.dart$' | head -10 | while read file; do
            echo "  - $file"
          done
        else
          echo "changes_made=false" >> $GITHUB_OUTPUT
        fi

    - name: Commit formatting fixes
      if: steps.fix_report.outputs.changes_made == 'true'
      run: |
        git config --local user.email "action@github.com"
        git config --local user.name "GitHub Action"
        git add .
        git commit -m "style: è‡ªå‹•ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆä¿®æ­£

        ä¿®æ­£ãƒ•ã‚¡ã‚¤ãƒ«æ•°: ${{ steps.fix_report.outputs.total_changes }}
        ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆåŸºæº–: dart format æº–æ‹ 
        è‡ªå‹•ä¿®æ­£å®Ÿè¡Œè€…: GitHub Actions"
        
        # ãƒ—ãƒ«ãƒªã‚¯ã‚¨ã‚¹ãƒˆã®å ´åˆã¯ã‚³ãƒŸãƒƒãƒˆã®ã¿ï¼ˆãƒ—ãƒƒã‚·ãƒ¥ã—ãªã„ï¼‰
        echo "âœ… ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆä¿®æ­£ã‚’ã‚³ãƒŸãƒƒãƒˆã—ã¾ã—ãŸï¼ˆãƒ—ãƒ«ãƒªã‚¯ã‚¨ã‚¹ãƒˆç”¨ï¼‰"

    - name: Send fix notification
      if: steps.fix_report.outputs.changes_made == 'true' && (vars.DISCORD_WEBHOOK_URL || vars.SLACK_WEBHOOK_URL)
      run: |
        if [ -n "${{ vars.DISCORD_WEBHOOK_URL }}" ]; then
          curl -H "Content-Type: application/json" \
          -d '{
            "embeds": [{
              "title": "ğŸ”§ ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆè‡ªå‹•ä¿®æ­£å®Œäº†",
              "description": "ã‚³ãƒ¼ãƒ‰ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆã®å•é¡Œã‚’è‡ªå‹•ã§ä¿®æ­£ã—ã¾ã—ãŸ",
              "color": 3066993,
              "fields": [
                {"name": "ä¿®æ­£ãƒ•ã‚¡ã‚¤ãƒ«æ•°", "value": "${{ steps.fix_report.outputs.total_changes }}", "inline": true},
                {"name": "ãƒ–ãƒ©ãƒ³ãƒ", "value": "${{ github.ref_name }}", "inline": true},
                {"name": "å®Ÿè¡Œè€…", "value": "${{ github.actor }}", "inline": true}
              ],
              "footer": {"text": "GitHub Actions"},
              "timestamp": "'$(date -u +%Y-%m-%dT%H:%M:%S.000Z)'"
            }]
          }' \
          ${{ vars.DISCORD_WEBHOOK_URL }}
        fi
        
        if [ -n "${{ vars.SLACK_WEBHOOK_URL }}" ]; then
          curl -X POST -H 'Content-type: application/json' \
          --data '{
            "text": "ğŸ”§ ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆè‡ªå‹•ä¿®æ­£å®Œäº†",
            "blocks": [
              {
                "type": "header",
                "text": {
                  "type": "plain_text",
                  "text": "ğŸ”§ TechLingual Quest ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆä¿®æ­£"
                }
              },
              {
                "type": "section",
                "text": {
                  "type": "mrkdwn",
                  "text": "ã‚³ãƒ¼ãƒ‰ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆã®å•é¡Œã‚’è‡ªå‹•ã§ä¿®æ­£ã—ã¾ã—ãŸ\nä¿®æ­£ãƒ•ã‚¡ã‚¤ãƒ«æ•°: *${{ steps.fix_report.outputs.total_changes }}*"
                }
              },
              {
                "type": "section",
                "fields": [
                  {"type": "mrkdwn", "text": "*ãƒ–ãƒ©ãƒ³ãƒ:*\n${{ github.ref_name }}"},
                  {"type": "mrkdwn", "text": "*å®Ÿè¡Œè€…:*\n${{ github.actor }}"}
                ]
              }
            ]
          }' \
          ${{ vars.SLACK_WEBHOOK_URL }}
        fi

    - name: Record format fix results
      if: always()
      run: |
        if [ "${{ steps.check_format.outputs.format_needed }}" == "true" ]; then
          if [ "${{ steps.fix_report.outputs.changes_made }}" == "true" ]; then
            echo "ğŸ”§ ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆä¿®æ­£: ${{ steps.fix_report.outputs.total_changes }}ãƒ•ã‚¡ã‚¤ãƒ«ä¿®æ­£å®Œäº†"
          else
            echo "âš ï¸ ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆå•é¡Œæ¤œå‡º: ä¿®æ­£ã¯ä¸è¦"
          fi
        else
          echo "âœ… ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆãƒã‚§ãƒƒã‚¯: ä¿®æ­£ä¸è¦"
        fi
        # çµ±åˆé€šçŸ¥ã‚·ã‚¹ãƒ†ãƒ ãŒçµæœã‚’åé›†

    - name: Format check summary
      run: |
        if [ "${{ steps.check_format.outputs.format_needed }}" == "true" ]; then
          if [ "${{ steps.fix_report.outputs.changes_made }}" == "true" ]; then
            echo "ğŸ¯ ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆä¿®æ­£ãƒ—ãƒ­ã‚»ã‚¹å®Œäº†ï¼š"
            echo "  1. èª¿æŸ»: ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆå•é¡Œã‚’æ¤œå‡º"
            echo "  2. ä¿®æ­£: ${{ steps.fix_report.outputs.total_changes }} ãƒ•ã‚¡ã‚¤ãƒ«ã‚’è‡ªå‹•ä¿®æ­£"
            echo "  3. å ±å‘Š: ä¿®æ­£å†…å®¹ã‚’é€šçŸ¥"
          else
            echo "âš ï¸ ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆå•é¡ŒãŒæ¤œå‡ºã•ã‚Œã¾ã—ãŸãŒã€ä¿®æ­£ã¯ä¸è¦ã§ã—ãŸ"
          fi
        else
          echo "âœ… ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆãƒã‚§ãƒƒã‚¯å®Œäº†: ä¿®æ­£ä¸è¦"
        fi
