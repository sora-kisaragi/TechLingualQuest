name: Security Scan

on:
  pull_request:
    branches: [ main, develop ]
  schedule:
    # æ¯æ—¥åˆå‰2æ™‚ï¼ˆUTCï¼‰ã«ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã‚¹ã‚­ãƒ£ãƒ³ã‚’å®Ÿè¡Œ
    - cron: '0 2 * * *'

permissions:
  contents: read
  actions: read
  security-events: write

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

env:
  FLUTTER_VERSION: '3.35.3'

jobs:
  security-scan:
    runs-on: ubuntu-latest
    name: Security Vulnerability Scan

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup Flutter
      uses: subosito/flutter-action@v2
      with:
        flutter-version: ${{ env.FLUTTER_VERSION }}
        channel: 'stable'
        cache: true

    - name: Get dependencies
      env:
        APP_ENV: dev
        DATABASE_NAME: tech_lingual_quest_test.db
        API_BASE_URL: https://api.example.com
        LOG_LEVEL: error
      run: flutter pub get

    - name: Run dependency audit
      env:
        APP_ENV: dev
        DATABASE_NAME: tech_lingual_quest_test.db
        API_BASE_URL: https://api.example.com
        LOG_LEVEL: error
      run: |
        # Flutter/Dartä¾å­˜é–¢ä¿‚ã®è„†å¼±æ€§ãƒã‚§ãƒƒã‚¯
        echo "ğŸ“¦ ä¾å­˜é–¢ä¿‚ã®å–å¾—ä¸­..."
        flutter pub get

        # ä¾å­˜é–¢ä¿‚ã®è§£æ
        if command -v jq &> /dev/null; then
          echo "ğŸ“¦ ä¾å­˜é–¢ä¿‚åˆ†æçµæœ:"
          dart pub deps --json > deps.json || echo "ä¾å­˜é–¢ä¿‚ã®è©³ç´°å‡ºåŠ›ã‚’ã‚¹ã‚­ãƒƒãƒ—"
          if [ -f "deps.json" ]; then
            jq '.packages[] | select(.kind == "direct") | {name: .name, version: .version}' deps.json 2>/dev/null || echo "JSONè§£æã‚’ã‚¹ã‚­ãƒƒãƒ—"
          fi
        fi

        # pubspec.lock ã®å†…å®¹ã‚’ãƒã‚§ãƒƒã‚¯
        if [ -f "pubspec.lock" ]; then
          echo "ğŸ”’ ãƒ­ãƒƒã‚¯ãƒ•ã‚¡ã‚¤ãƒ«ç¢ºèª: pubspec.lock ãŒå­˜åœ¨ã—ã¾ã™"
          echo "ğŸ“Š ä¾å­˜é–¢ä¿‚æ•°: $(grep -c '  [a-zA-Z]' pubspec.lock || echo 'ã‚«ã‚¦ãƒ³ãƒˆä¸å¯')"
        else
          echo "âš ï¸ è­¦å‘Š: pubspec.lock ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ï¼ˆflutter pub getã§ç”Ÿæˆã•ã‚Œã¾ã™ï¼‰"
        fi

        # æ—¢çŸ¥ã®è„†å¼±æ€§ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã®ãƒã‚§ãƒƒã‚¯ï¼ˆä¾‹ï¼‰
        if grep -q "vulnerable_package" pubspec.yaml; then
          echo "ğŸš¨ å±é™º: æ—¢çŸ¥ã®è„†å¼±æ€§ã‚’æŒã¤ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ãŒæ¤œå‡ºã•ã‚Œã¾ã—ãŸ"
          exit 1
        fi

    - name: Dart Static Analysis
      env:
        APP_ENV: dev
        DATABASE_NAME: tech_lingual_quest_test.db
        API_BASE_URL: https://api.example.com
        LOG_LEVEL: error
      run: |
        echo "ğŸ” Dartã‚³ãƒ¼ãƒ‰ã®é™çš„è§£æã‚’å®Ÿè¡Œä¸­..."
        flutter analyze --no-fatal-infos || echo "é™çš„è§£æã§è­¦å‘ŠãŒæ¤œå‡ºã•ã‚Œã¾ã—ãŸ"

        # ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã®å¥å…¨æ€§ãƒã‚§ãƒƒã‚¯
        echo "ğŸ“Š ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã®å¥å…¨æ€§ã‚’è©•ä¾¡ä¸­..."
        dart pub deps --style=tree || echo "ä¾å­˜é–¢ä¿‚ãƒ„ãƒªãƒ¼ã®è¡¨ç¤ºã‚’ã‚¹ã‚­ãƒƒãƒ—"

        # ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£é–¢é€£ã®è­¦å‘Šã‚’ãƒã‚§ãƒƒã‚¯
        if flutter analyze 2>&1 | grep -i "security\|unsafe\|vulnerability" >/dev/null 2>&1; then
          echo "âš ï¸ ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£é–¢é€£ã®è­¦å‘ŠãŒæ¤œå‡ºã•ã‚Œã¾ã—ãŸ"
        else
          echo "âœ… ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£é–¢é€£ã®è­¦å‘Šã¯æ¤œå‡ºã•ã‚Œã¾ã›ã‚“ã§ã—ãŸ"
        fi

    - name: Upload security scan results
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: security-scan-results
        path: |
          deps.json
          pubspec.lock
        retention-days: 30

    - name: Determine scan status
      id: scan_status
      if: always()
      run: |
        # ã‚³ãƒŸãƒƒãƒˆSHAã®çŸ­ç¸®ç‰ˆã‚’ä½œæˆ
        SHORT_SHA=$(echo "${{ github.sha }}" | cut -c1-7)
        echo "short_sha=$SHORT_SHA" >> $GITHUB_OUTPUT
        
        if [ "${{ job.status }}" == "success" ]; then
          echo "status=success" >> $GITHUB_OUTPUT
          echo "status_emoji=âœ…" >> $GITHUB_OUTPUT
          echo "status_color=3066993" >> $GITHUB_OUTPUT
          echo "status_message=ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã‚¹ã‚­ãƒ£ãƒ³ãŒæ­£å¸¸ã«å®Œäº†ã—ã¾ã—ãŸã€‚å•é¡Œã¯æ¤œå‡ºã•ã‚Œã¾ã›ã‚“ã§ã—ãŸã€‚" >> $GITHUB_OUTPUT
        else
          echo "status=failure" >> $GITHUB_OUTPUT
          echo "status_emoji=ğŸš¨" >> $GITHUB_OUTPUT
          echo "status_color=15158332" >> $GITHUB_OUTPUT
          echo "status_message=ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã‚¹ã‚­ãƒ£ãƒ³ã§å•é¡ŒãŒæ¤œå‡ºã•ã‚Œã¾ã—ãŸã€‚ç·Šæ€¥å¯¾å¿œãŒå¿…è¦ã§ã™ã€‚" >> $GITHUB_OUTPUT
        fi

    - name: Send security notification
      if: always() && (vars.DISCORD_WEBHOOK_URL || vars.SLACK_WEBHOOK_URL)
      run: |
        echo "ğŸ“¤ ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã‚¹ã‚­ãƒ£ãƒ³çµæœé€šçŸ¥ã‚’é€ä¿¡ä¸­..."
        echo "   â”” ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹: ${{ steps.scan_status.outputs.status }}"
        echo "   â”” ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸: ${{ steps.scan_status.outputs.status_message }}"
        
        if [ -n "${{ vars.DISCORD_WEBHOOK_URL }}" ]; then
          curl -H "Content-Type: application/json" \
          -d '{
            "embeds": [{
              "title": "${{ steps.scan_status.outputs.status_emoji }} ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã‚¹ã‚­ãƒ£ãƒ³å®Œäº†",
              "description": "${{ steps.scan_status.outputs.status_message }}",
              "color": ${{ steps.scan_status.outputs.status_color }},
              "fields": [
                {"name": "ãƒ–ãƒ©ãƒ³ãƒ", "value": "${{ github.ref_name }}", "inline": true},
                {"name": "ã‚³ãƒŸãƒƒãƒˆ", "value": "${{ steps.scan_status.outputs.short_sha }}", "inline": true},
                {"name": "å®Ÿè¡Œè€…", "value": "${{ github.actor }}", "inline": true},
                {"name": "ã‚¹ã‚­ãƒ£ãƒ³çµæœ", "value": "${{ steps.scan_status.outputs.status }}", "inline": true}
              ],
              "footer": {"text": "Security Scan Pipeline"},
              "timestamp": "'$(date -u +%Y-%m-%dT%H:%M:%S.000Z)'",
              "url": "https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}"
            }]
          }' \
          ${{ vars.DISCORD_WEBHOOK_URL }}
          echo "âœ… Discordé€šçŸ¥é€ä¿¡å®Œäº†"
        fi
        
        if [ -n "${{ vars.SLACK_WEBHOOK_URL }}" ]; then
          curl -X POST -H 'Content-type: application/json' \
          --data '{
            "text": "${{ steps.scan_status.outputs.status_emoji }} ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã‚¹ã‚­ãƒ£ãƒ³å®Œäº†",
            "blocks": [
              {
                "type": "header",
                "text": {
                  "type": "plain_text",
                  "text": "${{ steps.scan_status.outputs.status_emoji }} TechLingual Quest ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã‚¹ã‚­ãƒ£ãƒ³"
                }
              },
              {
                "type": "section",
                "text": {
                  "type": "mrkdwn",
                  "text": "${{ steps.scan_status.outputs.status_message }}"
                }
              },
              {
                "type": "section",
                "fields": [
                  {"type": "mrkdwn", "text": "*ãƒ–ãƒ©ãƒ³ãƒ:*\n${{ github.ref_name }}"},
                  {"type": "mrkdwn", "text": "*ã‚³ãƒŸãƒƒãƒˆ:*\n${{ steps.scan_status.outputs.short_sha }}"},
                  {"type": "mrkdwn", "text": "*å®Ÿè¡Œè€…:*\n${{ github.actor }}"},
                  {"type": "mrkdwn", "text": "*ã‚¹ã‚­ãƒ£ãƒ³çµæœ:*\n${{ steps.scan_status.outputs.status }}"}
                ]
              },
              {
                "type": "actions",
                "elements": [
                  {
                    "type": "button",
                    "text": {
                      "type": "plain_text",
                      "text": "ğŸ“Š è©³ç´°ã‚’GitHub Actionsã§ç¢ºèª"
                    },
                    "url": "https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}",
                    "style": "primary"
                  }
                ]
              }
            ]
          }' \
          ${{ vars.SLACK_WEBHOOK_URL }}
          echo "âœ… Slacké€šçŸ¥é€ä¿¡å®Œäº†"
        fi


